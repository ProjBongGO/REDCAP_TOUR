<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <title>Stock API Simple</title>
</head>
<body>

    <input type="text" id="key" placeholder="서비스키 입력">
    <input type="text" id="date" placeholder="날짜(20250731)">
    <button onclick="getData()">조회 시작</button>

    <div id="status">상태: 대기 중</div>
    <ul id="list"></ul>

    <script>
        async function getData() {
            // [1] 입력값 가져오기
            const key = document.getElementById('key').value;
            const date = document.getElementById('date').value;
            const list = document.getElementById('list');
            const status = document.getElementById('status');

            let page = 1;
            let total = [];
            status.innerText = "조회 중...";
            list.innerHTML = "";

            try {
                while (true) {
                    // [2] API 주소 및 매개변수 설정 (★여기에 검색 조건 추가★)
                    // URL 끝에 &항목명=값 형식으로 붙이면 됩니다.
                    let url = `https://apis.data.go.kr/1160100/service/GetStockSecuritiesInfoService/getStockPriceInfo`
                        + `?serviceKey=${key}`      // 필수: 인증키
                        + `&resultType=json`        // 필수: 결과 형식
                        + `&numOfRows=100`          // 한번에 가져올 수 (최대 1000)
                        + `&pageNo=${page}`         // 현재 페이지 번호
                        + `&basDt=${date}`;         // 기준 일자
                    
                    // 만약 특정 종목명만 찾고 싶다면 아래 주석을 풀고 사용하세요.
                    // url += `&itmsNm=삼성전자`; 

                    // [3] 실제 API 호출
                    const res = await fetch(url);
                    const data = await res.json();
                    
                    // [4] 데이터 검증 및 추출
                    const items = data.response.body.items.item;
                    if (!items || items.length === 0) break; // 더 이상 데이터 없으면 중단

                    // [5] 화면에 표시할 내용 (종목명, 가격 등)
                    items.forEach(item => {
                        const li = document.createElement('li');
                        // 출력하고 싶은 항목을 item.항목명 형식으로 적으세요.
                        li.innerText = `${item.itmsNm} (${item.srtnCd}) - 종가: ${item.clpr}`;
                        list.appendChild(li);
                        total.push(item);
                    });

                    // [6] 전체 개수 확인 후 종료
                    const totalCount = data.response.body.totalCount;
                    if (total.length >= totalCount) break;

                    // [7] 15 TPS 속도 조절 (약 0.07초 대기)
                    page++;
                    await new Promise(r => setTimeout(r, 70));
                }
                status.innerText = `완료: 전체 ${total.length}건 수집됨`;

            } catch (e) {
                status.innerText = "에러: " + e.message;
                console.error(e);
            }
        }
    </script>
</body>
</html>